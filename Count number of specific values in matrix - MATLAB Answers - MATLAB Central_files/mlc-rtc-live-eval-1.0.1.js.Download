var original_doc_title = document.title;
var is_executing = false;

function switch_to_inline_outputs() {
  rtcObj.rtcInstance.getActionDataService().executeAction('rtc_inline_view_no_animation');
}

function adjust_editor_width() {
  // Removing output arrangement options needs editor width adjustment
  $('.rteWindow.borderContainer.dijitContainer.mwLayoutContainer.borderContainerWithSplitter').css('width','100%');
  $('.rteWindow.borderContainer.dijitContainer.mwLayoutContainer.borderContainerWithSplitter > div').css('width','100%');
  $(window).resize(function(){
    setTimeout(function(){
      $('.rteWindow.borderContainer.dijitContainer.mwLayoutContainer.borderContainerWithSplitter').css('width','100%');
    }, 1);
  });
}

function stopRequest() {
  rtcObj.rtcInstance.getActionDataService().executeAction('rtc_interrupt');
  $('.live_eval_in_progress_mask, .before-mss-call-alert').remove();
  rtcObj.rtcInstance.focus();
  rtcObj.rtcInstance.getCursor().show();
}

function uuidv4() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

function get_token(url) {
  $.ajax({
    dataType: "json",
    url: url,
    async: false
  }).success(function (data) {
    token = data['su_token'];
  });
  return token;
}

function is_code_in_rtc() {
  var contains_code = true;
  try {
    contains_code = rtcObj.rtcInstance.getDocument().getCodeText().trim() != "";
  } catch (e) {}
  return contains_code;
}

function is_output_present_in_rtc() {
  return $('#rtc_editor_with_toolstrip').find('.mlc_live_eval .CodeBlock .inlineWrapper.outputs').length > 0;
}

function has_rtc_code_ran() {
  return $('#run_count').val() != '0';
}

function mask_editor() {
  var editor_progress_div = $('<div class="live_eval_in_progress_mask"></div>');
  $(editor_progress_div).css({
    "width": $('.rtc_editor_with_toolstrip').width() + "px",
    "height": $('.rtc_editor_with_toolstrip').height() + "px"
  });
  $('.rtc_editor_with_toolstrip').before(editor_progress_div);
  $(window).resize(function() {
    $(editor_progress_div).css({
      "width": $('.rtc_editor_with_toolstrip').width() + "px",
      "height": $('.rtc_editor_with_toolstrip').height() + "px"
    });
  });
  $('.before-mss-call-alert').toggleClass('open');
}

function show_banner(status, banner_title, banner_desc) {
  update_browser_tab(status);

  if (status=='executing') {
    var banner_div = $('<div class="alert alert-info before-mss-call-alert"></div>');
    var banner_icon_span = $('<span class="alert_icon icon-alert-info-reverse"></span>').appendTo(banner_div);
    var banner_title = $('<strong>Executing in <span class="'+ rtcObj.version() + '_logo"></span></strong>');
  } else if(status=='success') {
    var banner_div = $('<div class="alert alert-success alert-dismissible after-mss-call-alert"></div>');
    var banner_icon_span = $('<span class="alert_icon icon-alert-success"></span>').appendTo(banner_div);
    var banner_title = $('<strong>Ran in <span class="'+ rtcObj.version() + '_logo"></span></strong>');
  } else if(status=='warning') {
    var banner_div = $('<div class="alert alert-warning alert-dismissible after-mss-call-alert"></div>');
    var banner_icon_span = $('<span class="alert_icon icon-alert-warning"></span>').appendTo(banner_div);
    var banner_title = $('<strong>' + banner_title + '</strong>');
  } else {
    var banner_div = $('<div class="alert alert-danger alert-dismissible after-mss-call-alert"></div>');
    var banner_icon_span = $('<span class="alert_icon icon-alert-error"></span>').appendTo(banner_div);
    var banner_title = $("<strong>" + banner_title + "</strong>");
  }

  if (status=='executing') {
    var spinner_outer_div = $('<div class="progress_spinner progress_spinner_indeterminate"></div>');
    var spinner_inner_div = $('<div class="progress_spinner_dial"></div>").appendTo(spinner_outer_div').appendTo(spinner_outer_div);

    var stop_exec_div = $('<div class="stop_execution_in_alert" style="pointer"></div>');
    var stop_icon_div = $('<div class="mwIconNode end_16 stop_icon_in_alert"></div>').appendTo(stop_exec_div);
    stop_exec_div.append(document.createTextNode("Stop"));
    stop_exec_div.on("click", function(){
      stopRequest();
      update_tab_title_and_favicon();
    });
  } else {
    var dismiss_button = $('<button type="button" class="close" data-dismiss="alert" aria-label="Close"></button>');
    var dismiss_btn_icon = $('<span aria-hidden="true">&times;</span>').appendTo(dismiss_button);
    banner_div.append(dismiss_button);
  }

  var banner_heading = $("<p class=\"alert_heading\"></p>").append(banner_title);
  banner_div.append(banner_heading);

  if (status=='executing') {
    banner_div.append(spinner_outer_div);
    banner_div.append(stop_exec_div);
  } else if (status=='error' || status=='warning') {
    var msg_div = $('<div>' + banner_desc + '</div>');
    banner_div.append(msg_div);
  }

  var live_eval_banner = $('.live_eval_banner').length > 0 ? $('.live_eval_banner')[0] : $("<div class=\"live_eval_banner\"></div>");
  var banner_outer_div = $(live_eval_banner).append(banner_div);

  $("body").append(banner_outer_div);
  position_banner(banner_outer_div);

  if (status=='success') {
    fadeout_element('.after-mss-call-alert:last-child');
  }
}

function fadeout_element(ele) {
  try {
    function fade_after_timeout() {
      var timeout_handle = setTimeout(function(){
        $(ele).fadeOut(2500);
      },10000);
      return timeout_handle;
    }
    var timeout_handle = fade_after_timeout();
    $(ele).mouseenter(function(){
      clearTimeout(timeout_handle);
      $(this).stop(true).css('opacity', 1.0);
     });
    $(ele).mouseleave(function(){
      timeout_handle = fade_after_timeout();
    });
  } catch(e){}
}

function position_banner(div) {
  $(div).css("top", getHeaderHeight() + "px");
  $(window).on("resize scroll",function(){
    $(div).css("top", getHeaderHeight() + "px");
  });
}

function update_browser_tab(status){
  try{
    if(status == 'executing') {
      update_tab_title_and_favicon('Executing... ' + original_doc_title, '/matlabcentral/static/rtc/images/run_favicons/executing.ico');
      is_executing = true;
    } else if(status == 'success' || status == 'error') {
      is_executing = false;
      if (document.visibilityState == 'visible') {
        update_tab_title_and_favicon();
      } else {
        if (status == 'success') {
          update_tab_title_and_favicon('(Execution complete) ' + original_doc_title, '/matlabcentral/static/rtc/images/run_favicons/success.ico');
        } else if (status == 'error') {
          update_tab_title_and_favicon('(Execution error) ' + original_doc_title, '/matlabcentral/static/rtc/images/run_favicons/error.ico');
        }
      }
    }
    window.onfocus = function() {
      if (!is_executing) update_tab_title_and_favicon();
    };
  } catch(e){}
}

function update_tab_title_and_favicon(title, favicon_url) {
  if (typeof title === 'undefined') title = original_doc_title;
  if (typeof favicon_url === 'undefined') favicon_url = 'https://www.mathworks.com/favicon.ico';
  
  // Update title
  document.title = title;
  
  // Update favicon
  var link = document.querySelector("link[rel~='icon']");
  if (!link) {
    link = document.createElement('link');
    link.rel = 'icon';
    link.href = favicon_url;
    document.getElementsByTagName('head')[0].appendChild(link);
  } else {
    link.href = favicon_url;
  }
}

function resize_editor_after_outputs() {
  setTimeout(function() { require(["dojo/topic"], function(topic){ topic.publish('viewChanged'); }); }, 50);
}

function get_ran_in_label(ml_version){
  return '<div class="ran_in_logo_div"><div class="ran_in_label">Ran in: <span class="'+ ml_version + '_logo"></span></div><div style="clear: both;"></div></div>';
}

function update_ran_in_label(dom_id) {
  if ($("#content_" + dom_id).prev().hasClass('ran_in_logo_div')) {
    $("#content_" + dom_id).prev().remove();
  }
  if ($("#body_" + dom_id).find('.rtcContent .CodeBlock .inlineWrapper.outputs').length) {
    $("#content_" + dom_id).before(get_ran_in_label(rtcObj.version()));
  }
}

// Add code detected hint
function add_code_detection_hint() {
  if($('div[data-tag="motwToolstrip.liveEditorTab.run.run"]').length && $('.rtc_tagline').length) {    
    function update() {
      if( is_code_in_rtc() && !has_rtc_code_ran() && !is_output_present_in_rtc() ) {
        add_run_tip();
      } else {
        remove_run_tip_if_present();
      }
    }
    
    $( document ).ready(function() {
      // Update on keyup
      $(".mlc_editor.mlc_live_eval").on("keyup", function() {
        update();
      });

      // Update on view update
      require(["dojo/topic"],function(topic){
        topic.subscribe('viewChanged', function(){
          update();
        });
      });

      // Update on paste
      $('#rtc_editor_with_toolstrip').bind('paste', function(e) {
        if (rtcObj.rtcInstance.focused) update();
      });
    });

    function add_run_tip() {
      if(!$('.rtc_tagline .run_detected_tagline').length) {
        add_tip_below_rtc_editor();
      }
    }

    function add_tip_below_rtc_editor() {
      $('.rtc_tagline .tagline_text').html(`
        <span class="alert_icon icon-alert-info-reverse"></span>
        <span class="run_detected_text">Code detected. Click or tap <div class="run_detected_logo run_16"></div> to run.</span>
      `);
      $('.rtc_tagline .tagline_text').addClass('run_detected_tagline');
    }

    function remove_run_tip_if_present() {
      $('.rtc_tagline .run_detected_tagline').html('');
      $('.rtc_tagline .tagline_text').removeClass('run_detected_tagline');
    }
    
  }
}

function show_qr_widget() {
  $('#quick_replies_widget').css('display','inline-flex');
}

function hide_qr_widget() {
  $('#quick_replies_widget').css('display','none');
}
